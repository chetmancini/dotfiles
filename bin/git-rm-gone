#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail

# git-rm-gone: Delete local branches whose upstream tracking branch is gone
#
# Removes branches where the remote branch was deleted after merge/close

# Handle branches with prefixes (* for current, + for worktree)
gone_branches=$(git branch -vv | grep ': gone]' | sed 's/^[* +]*//' | awk '{print $1}')

if [[ -z "$gone_branches" ]]; then
  echo "No branches with gone upstreams found."
  exit 0
fi

echo "Branches with gone upstreams:"
echo "$gone_branches"
echo ""

current_branch=$(git branch --show-current)

for branch in $gone_branches; do
  if [[ "$branch" == "$current_branch" ]]; then
    echo "Skipping $branch (current branch)"
    continue
  fi
  echo "Deleting $branch..."
  git branch -D "$branch"
done

echo ""
echo "Done."
