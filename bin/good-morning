#!/bin/bash

# good-morning: Run a configurable set of tasks to start the day
#
# Configuration file: ~/.config/good-morning/config
# If no config file exists, uses sensible defaults

set -e

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Source shared helpers
source "$SCRIPT_DIR/lib/helpers.sh"

CONFIG_DIR="$HOME/.config/good-morning"
CONFIG_FILE="$CONFIG_DIR/config"

# Default configuration (only for good-morning specific settings)
DEFAULT_CHECK_DISK_SPACE=true
DEFAULT_DISK_WARN_THRESHOLD=80

# Load configuration or use defaults
load_config() {
    CHECK_DISK_SPACE="$DEFAULT_CHECK_DISK_SPACE"
    DISK_WARN_THRESHOLD="$DEFAULT_DISK_WARN_THRESHOLD"

    if [ -f "$CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi
}

print_header() {
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  ☀️  Good Morning! Let's get your machine ready${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
}

print_footer() {
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  Done! Have a great day!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# Check disk space
check_disk_space() {
    if [ "$CHECK_DISK_SPACE" != true ]; then
        return
    fi

    print_section "Checking disk space..."

    # Get disk usage percentage for root volume
    disk_usage=$(df -h / | awk 'NR==2 {gsub(/%/,""); print $5}')
    disk_available=$(df -h / | awk 'NR==2 {print $4}')
    disk_total=$(df -h / | awk 'NR==2 {print $2}')

    if [ "$disk_usage" -ge "$DISK_WARN_THRESHOLD" ]; then
        print_error "Disk usage is at ${disk_usage}% (${disk_available} free of ${disk_total})"
    else
        print_success "Disk usage: ${disk_usage}% (${disk_available} free of ${disk_total})"
    fi
    echo ""
}

# Generate default config file
generate_config() {
    mkdir -p "$CONFIG_DIR"
    cat > "$CONFIG_FILE" << 'EOF'
# good-morning configuration
# Uncomment and modify settings as needed

# Disk space check
# CHECK_DISK_SPACE=true
# DISK_WARN_THRESHOLD=80  # Warn if usage exceeds this percentage

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# update-everything settings
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Directory containing git repositories to update
# REPOS_DIR="$HOME/norm"

# Default branch to pull (will fall back to master if main doesn't exist)
# MAIN_BRANCH="main"

# Homebrew tasks
# RUN_BREW_UPDATE=true
# RUN_BREW_UPGRADE=true
# RUN_BREW_CLEANUP=true

# Pull latest from repos
# PULL_REPOS=true

# Docker cleanup (only runs if Docker is installed and running)
# DOCKER_PRUNE=true

# macOS updates check (just reports, doesn't install)
# CHECK_MACOS_UPDATES=true

# Neovim plugin updates (only runs if nvim is installed)
# UPDATE_NVIM_PLUGINS=true

# Dotfiles updates
# PULL_DOTFILES=true
# DOTFILES_DIR="$HOME/dotfiles"

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# dashboard settings
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Calendar events (requires gcalcli)
# SHOW_CALENDAR=true
# CALENDAR_DAYS=1  # Number of days to show (0 = today only)
# CALENDAR_NAME=""  # Specific calendar to show (empty = all calendars)

# GitHub notifications (requires gh CLI)
# SHOW_GITHUB_NOTIFICATIONS=true
# GITHUB_NOTIFICATIONS_LIMIT=10
EOF
    echo "Generated config file at $CONFIG_FILE"
}

print_help() {
    echo "Usage: good-morning [options]"
    echo ""
    echo "Run a configurable set of tasks to start your day."
    echo ""
    echo "Options:"
    echo "  -h, --help       Show this help message"
    echo "  -v, --verbose    Show verbose output"
    echo "  --init           Generate a default config file at ~/.config/good-morning/config"
    echo "  --dry-run        Show what would be done without executing"
    echo ""
    echo "Configuration:"
    echo "  Config file location: ~/.config/good-morning/config"
    echo ""
    echo "This script orchestrates:"
    echo "  1. Disk space check"
    echo "  2. update-everything (brew, docker, nvim, dotfiles, repos)"
    echo "  3. dashboard (GitHub notifications, and more)"
    echo ""
    echo "You can also run these scripts individually:"
    echo "  update-everything    Run all updates"
    echo "  dashboard            Show dashboard info"
    exit 0
}

dry_run() {
    load_config
    echo "Dry run - would execute the following:"
    echo ""
    echo "Configuration:"
    echo "  CHECK_DISK_SPACE=$CHECK_DISK_SPACE"
    echo "  DISK_WARN_THRESHOLD=$DISK_WARN_THRESHOLD"
    echo ""

    if [ "$CHECK_DISK_SPACE" = true ]; then
        echo "Would check: disk space (warn if > ${DISK_WARN_THRESHOLD}%)"
    fi
    echo ""
    echo "Would run: update-everything --no-header"
    "$SCRIPT_DIR/update-everything" --dry-run | sed 's/^/  /'
    echo ""
    echo "Would run: dashboard --no-header"
    "$SCRIPT_DIR/dashboard" --dry-run | sed 's/^/  /'
    exit 0
}

# Main
main() {
    local verbose_flag=""

    # Parse arguments
    while [ $# -gt 0 ]; do
        case "$1" in
            -h|--help)
                print_help
                ;;
            -v|--verbose)
                VERBOSE=true
                verbose_flag="-v"
                shift
                ;;
            --init)
                generate_config
                exit 0
                ;;
            --dry-run)
                dry_run
                ;;
            *)
                echo "Unknown option: $1"
                echo "Run 'good-morning --help' for usage."
                exit 1
                ;;
        esac
    done

    load_config
    print_header

    # Health checks
    check_disk_space

    # Run updates
    "$SCRIPT_DIR/update-everything" --no-header $verbose_flag

    # Show dashboard
    "$SCRIPT_DIR/dashboard" --no-header

    print_footer
}

main "$@"
