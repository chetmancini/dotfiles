#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail

# update-everything: Update all software and pull latest code
#
# Configuration file: ~/.config/good-morning/config
# Can be run standalone or called from good-morning

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Source shared helpers
source "$SCRIPT_DIR/lib/helpers.sh"

CONFIG_DIR="$HOME/.config/good-morning"
CONFIG_FILE="$CONFIG_DIR/config"

# Default configuration
DEFAULT_REPOS_DIRS=("$HOME/code" "$HOME/norm")
DEFAULT_RUN_BREW_UPDATE=true
DEFAULT_RUN_BREW_UPGRADE=true
DEFAULT_RUN_BREW_CLEANUP=true
DEFAULT_PULL_REPOS=true
DEFAULT_DOCKER_PRUNE=true
DEFAULT_CHECK_MACOS_UPDATES=true
DEFAULT_UPDATE_NVIM_PLUGINS=true

# Load configuration or use defaults
load_config() {
    REPOS_DIRS=("${DEFAULT_REPOS_DIRS[@]}")
    RUN_BREW_UPDATE="$DEFAULT_RUN_BREW_UPDATE"
    RUN_BREW_UPGRADE="$DEFAULT_RUN_BREW_UPGRADE"
    RUN_BREW_CLEANUP="$DEFAULT_RUN_BREW_CLEANUP"
    PULL_REPOS="$DEFAULT_PULL_REPOS"
    DOCKER_PRUNE="$DEFAULT_DOCKER_PRUNE"
    CHECK_MACOS_UPDATES="$DEFAULT_CHECK_MACOS_UPDATES"
    UPDATE_NVIM_PLUGINS="$DEFAULT_UPDATE_NVIM_PLUGINS"

    if [ -f "$CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi
}

# Homebrew tasks
run_brew_tasks() {
    if [ "$RUN_BREW_UPDATE" = true ]; then
        print_section "Updating Homebrew..."
        if brew update; then
            print_success "Homebrew updated"
        else
            print_error "Failed to update Homebrew"
        fi
        echo ""
    fi

    if [ "$RUN_BREW_UPGRADE" = true ]; then
        print_section "Upgrading packages..."
        if brew upgrade; then
            print_success "Packages upgraded"
        else
            print_error "Failed to upgrade packages"
        fi
        echo ""
    fi

    if [ "$RUN_BREW_CLEANUP" = true ]; then
        print_section "Cleaning up Homebrew..."
        if brew cleanup; then
            print_success "Homebrew cleaned up"
        else
            print_error "Failed to cleanup Homebrew"
        fi
        echo ""
    fi
}

# Check for macOS updates (just report, don't install)
check_macos_updates() {
    if [ "$CHECK_MACOS_UPDATES" != true ]; then
        return
    fi

    # Only run on macOS
    if [ "$(uname)" != "Darwin" ]; then
        return
    fi

    print_section "Checking for macOS updates..."

    # softwareupdate -l lists available updates
    updates=$(softwareupdate -l 2>&1)

    if echo "$updates" | grep -q "No new software available"; then
        print_success "macOS is up to date"
    else
        # Count updates (lines starting with *)
        update_count=$(echo "$updates" | grep -c "^\*" || true)
        if [ "$update_count" -gt 0 ]; then
            print_error "$update_count macOS update(s) available"
            echo "$updates" | grep "^\*" | while read -r line; do
                print_info "  $line"
            done
            print_info "  Run 'softwareupdate -i -a' to install all updates"
        else
            print_success "macOS is up to date"
        fi
    fi
    echo ""
}

# Docker cleanup
run_docker_prune() {
    if [ "$DOCKER_PRUNE" != true ]; then
        return
    fi

    # Check if Docker is installed and running
    if ! command -v docker &>/dev/null; then
        return
    fi

    if ! docker info &>/dev/null; then
        print_section "Docker cleanup..."
        print_info "Docker is not running, skipping"
        echo ""
        return
    fi

    print_section "Cleaning up Docker..."

    # Get space before cleanup
    space_before=$(docker system df --format '{{.Reclaimable}}' 2>/dev/null | head -1)

    if docker system prune -f &>/dev/null; then
        print_success "Docker cleaned up (was reclaimable: $space_before)"
    else
        print_error "Failed to clean up Docker"
    fi
    echo ""
}

# Update Neovim plugins via Lazy
update_nvim_plugins() {
    if [ "$UPDATE_NVIM_PLUGINS" != true ]; then
        return
    fi

    # Check if nvim is installed
    if ! command -v nvim &>/dev/null; then
        return
    fi

    print_section "Updating Neovim plugins..."

    if run_with_spinner "Syncing plugins..." nvim --headless "+Lazy! sync" +qa; then
        print_success "Neovim plugins updated"
    else
        print_error "Failed to update Neovim plugins"
    fi
    echo ""
}

# Pull latest from main on all git repos in configured directories
pull_repos() {
    if [ "$PULL_REPOS" != true ]; then
        return
    fi

    print_section "Pulling latest in repos..."
    echo ""

    for repos_dir in "${REPOS_DIRS[@]}"; do
        if [ ! -d "$repos_dir" ]; then
            print_info "Skipping $repos_dir (not found)"
            continue
        fi

        print_info "Scanning $repos_dir..."

        for repo in "$repos_dir"/*/; do
            if [ -d "$repo/.git" ]; then
                repo_name=$(basename "$repo")

                (
                    cd "$repo"

                    # Check if there are uncommitted changes
                    if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
                        print_error "$repo_name has uncommitted changes, skipping"
                        exit 0
                    fi

                    # Fetch latest
                    if ! git fetch origin 2>/dev/null; then
                        print_error "$repo_name: failed to fetch"
                        exit 0
                    fi

                    # Detect the primary branch (try main first, then master)
                    if git show-ref --verify --quiet "refs/remotes/origin/main"; then
                        branch="main"
                    elif git show-ref --verify --quiet "refs/remotes/origin/master"; then
                        branch="master"
                    else
                        print_error "$repo_name: no main/master branch found"
                        exit 0
                    fi

                    current_branch=$(git rev-parse --abbrev-ref HEAD)

                    if [ "$current_branch" = "$branch" ]; then
                        # On main branch, just pull
                        if git pull --ff-only origin "$branch" 2>/dev/null; then
                            print_success "$repo_name: pulled latest on $branch"
                        else
                            print_error "$repo_name: failed to pull (might need rebase)"
                        fi
                    else
                        # On a different branch, fetch main
                        if git fetch origin "$branch:$branch" 2>/dev/null; then
                            print_success "$repo_name: updated $branch (currently on $current_branch)"
                        else
                            print_info "$repo_name: $branch is up to date (currently on $current_branch)"
                        fi
                    fi
                )
            fi
        done
    done
    echo ""
}

print_help() {
    echo "Usage: update-everything [options]"
    echo ""
    echo "Update all software and pull latest code."
    echo ""
    echo "Options:"
    echo "  -h, --help       Show this help message"
    echo "  -v, --verbose    Show verbose output"
    echo "  --dry-run        Show what would be done without executing"
    echo ""
    echo "Configuration:"
    echo "  Config file location: ~/.config/good-morning/config"
    echo ""
    echo "Tasks:"
    echo "  - Check for macOS updates"
    echo "  - brew update / upgrade / cleanup"
    echo "  - Docker system prune"
    echo "  - Update Neovim plugins"
    echo "  - Pull latest main branch on all git repos in ~/code and ~/norm"
    exit 0
}

dry_run() {
    load_config
    echo "Dry run - would execute the following:"
    echo ""
    echo "Configuration:"
    echo "  REPOS_DIRS=${REPOS_DIRS[*]}"
    echo "  RUN_BREW_UPDATE=$RUN_BREW_UPDATE"
    echo "  RUN_BREW_UPGRADE=$RUN_BREW_UPGRADE"
    echo "  RUN_BREW_CLEANUP=$RUN_BREW_CLEANUP"
    echo "  PULL_REPOS=$PULL_REPOS"
    echo "  DOCKER_PRUNE=$DOCKER_PRUNE"
    echo "  CHECK_MACOS_UPDATES=$CHECK_MACOS_UPDATES"
    echo "  UPDATE_NVIM_PLUGINS=$UPDATE_NVIM_PLUGINS"
    echo ""

    if [ "$CHECK_MACOS_UPDATES" = true ]; then
        echo "Would check: macOS software updates"
    fi
    if [ "$RUN_BREW_UPDATE" = true ]; then
        echo "Would run: brew update"
    fi
    if [ "$RUN_BREW_UPGRADE" = true ]; then
        echo "Would run: brew upgrade"
    fi
    if [ "$RUN_BREW_CLEANUP" = true ]; then
        echo "Would run: brew cleanup"
    fi
    if [ "$DOCKER_PRUNE" = true ]; then
        if command -v docker &>/dev/null; then
            echo "Would run: docker system prune -f"
        else
            echo "Would run: docker system prune -f (Docker not installed)"
        fi
    fi
    if [ "$UPDATE_NVIM_PLUGINS" = true ]; then
        if command -v nvim &>/dev/null; then
            echo "Would run: nvim --headless \"+Lazy! sync\" +qa"
        else
            echo "Would run: nvim plugin update (nvim not installed)"
        fi
    fi
    if [ "$PULL_REPOS" = true ]; then
        echo "Would pull latest (main or master) in:"
        for repos_dir in "${REPOS_DIRS[@]}"; do
            if [ -d "$repos_dir" ]; then
                echo "  $repos_dir:"
                for repo in "$repos_dir"/*/; do
                    if [ -d "$repo/.git" ]; then
                        echo "    - $(basename "$repo")"
                    fi
                done
            else
                echo "  $repos_dir (not found)"
            fi
        done
    fi
    exit 0
}

SHOW_HEADER=true

# Main
main() {
    # Parse arguments
    while [ $# -gt 0 ]; do
        case "$1" in
            -h|--help)
                print_help
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            --no-header)
                SHOW_HEADER=false
                shift
                ;;
            --dry-run)
                dry_run
                ;;
            *)
                echo "Unknown option: $1"
                echo "Run 'update-everything --help' for usage."
                exit 1
                ;;
        esac
    done

    load_config

    if [ "$SHOW_HEADER" = true ]; then
        echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${BLUE}  Updating everything...${NC}"
        echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
    fi

    check_macos_updates
    run_brew_tasks
    run_docker_prune
    update_nvim_plugins
    pull_repos

    if [ "$SHOW_HEADER" = true ]; then
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GREEN}  All updates complete!${NC}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    fi
}

main "$@"
