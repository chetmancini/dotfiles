#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail

# extract: Extract various archive formats
#
# Supports: tar.gz, tar.bz2, tar.xz, zip, rar, 7z, and more

# Function to check if a specific tool is installed
require_tool() {
    local tool="$1"
    local install_hint="${2:-}"
    if ! command -v "$tool" &>/dev/null; then
        echo "Error: '$tool' is not installed."
        [[ -n "$install_hint" ]] && echo "Install with: $install_hint"
        exit 1
    fi
}

# Function to print help message
print_help() {
    echo "Usage: extract [-v | -q] <file> [destination]"
    echo "Extracts a variety of archive formats such as .tar.gz, .zip, .rar, etc."
    echo "Options:"
    echo "  -v    Verbose mode (default)"
    echo "  -q    Quiet mode (minimal output)"
    echo "Arguments:"
    echo "  <file>        The file to be extracted"
    echo "  [destination] Optional target directory (default: current directory)"
    exit 0
}

# Parse options and set verbose or quiet mode
VERBOSE=1
while getopts "vqh" opt; do
    case $opt in
        v) VERBOSE=1 ;; # Verbose mode
        q) VERBOSE=0 ;; # Quiet mode
        h) print_help ;;
        *) print_help ;;
    esac
done
shift $((OPTIND - 1))

# Check if a file was provided
if [[ -z "$1" ]]; then
    print_help
fi

# Assign arguments
FILE="$1"
TARGET_DIR="${2:-.}"

# Check if the file exists
if [[ ! -f "$FILE" ]]; then
    echo "Error: '$FILE' is not a valid file"
    exit 1
fi

# Create target directory if it doesn't exist
if [[ ! -d "$TARGET_DIR" ]]; then
    mkdir -p "$TARGET_DIR"
fi

# Determine verbosity flags
if [[ "$VERBOSE" -eq 1 ]]; then
    TAR_FLAGS="xv"
else
    TAR_FLAGS="x"
fi

# Extract the file based on its extension
case "$FILE" in
    *.tar.bz2)
        require_tool "tar"
        tar "${TAR_FLAGS}jf" "$FILE" -C "$TARGET_DIR"
        ;;
    *.tar.gz)
        require_tool "tar"
        tar "${TAR_FLAGS}zf" "$FILE" -C "$TARGET_DIR"
        ;;
    *.bz2)
        require_tool "bunzip2" "brew install bzip2"
        bunzip2 -c "$FILE" > "$TARGET_DIR/$(basename "${FILE%.bz2}")"
        ;;
    *.rar)
        require_tool "unrar" "brew install unrar"
        if [[ "$VERBOSE" -eq 1 ]]; then
            unrar x -y "$FILE" "$TARGET_DIR"
        else
            unrar x -y "$FILE" "$TARGET_DIR" > /dev/null 2>&1
        fi
        ;;
    *.gz)
        require_tool "gunzip"
        gunzip -c "$FILE" > "$TARGET_DIR/$(basename "${FILE%.gz}")"
        ;;
    *.tar)
        require_tool "tar"
        tar "${TAR_FLAGS}f" "$FILE" -C "$TARGET_DIR"
        ;;
    *.tbz2)
        require_tool "tar"
        tar "${TAR_FLAGS}jf" "$FILE" -C "$TARGET_DIR"
        ;;
    *.tgz)
        require_tool "tar"
        tar "${TAR_FLAGS}zf" "$FILE" -C "$TARGET_DIR"
        ;;
    *.zip)
        require_tool "unzip"
        if [[ "$VERBOSE" -eq 1 ]]; then
            unzip "$FILE" -d "$TARGET_DIR"
        else
            unzip -q "$FILE" -d "$TARGET_DIR"
        fi
        ;;
    *.Z)
        require_tool "uncompress" "brew install ncompress"
        uncompress -c "$FILE" > "$TARGET_DIR/$(basename "${FILE%.Z}")"
        ;;
    *.7z)
        require_tool "7z" "brew install p7zip"
        if [[ "$VERBOSE" -eq 1 ]]; then
            7z x "$FILE" -o"$TARGET_DIR"
        else
            7z x "$FILE" -o"$TARGET_DIR" > /dev/null 2>&1
        fi
        ;;
    *.xz)
        require_tool "xz"
        xz -dc "$FILE" > "$TARGET_DIR/$(basename "${FILE%.xz}")"
        ;;
    *.tar.xz)
        require_tool "tar"
        tar "${TAR_FLAGS}Jf" "$FILE" -C "$TARGET_DIR"
        ;;
    *.zst)
        require_tool "zstd" "brew install zstd"
        zstd -dc "$FILE" > "$TARGET_DIR/$(basename "${FILE%.zst}")"
        ;;
    *.zstd)
        require_tool "zstd" "brew install zstd"
        zstd -dc "$FILE" > "$TARGET_DIR/$(basename "${FILE%.zstd}")"
        ;;
    *.tar.zst)
        require_tool "tar"
        require_tool "zstd" "brew install zstd"
        zstd -dc "$FILE" | tar "${TAR_FLAGS}f" - -C "$TARGET_DIR"
        ;;
    *.tar.zstd)
        require_tool "tar"
        require_tool "zstd" "brew install zstd"
        zstd -dc "$FILE" | tar "${TAR_FLAGS}f" - -C "$TARGET_DIR"
        ;;
    *)
        echo "Error: '$FILE' cannot be extracted via extract"
        echo "Supported formats: .tar.bz2, .tar.gz, .tar.xz, .tar.zst, .bz2, .rar, .gz, .tar, .tbz2, .tgz, .zip, .Z, .7z, .xz, .zst"
        exit 1
        ;;
esac

# Notify the user of completion
if [[ "$VERBOSE" -eq 1 ]]; then
    echo "Extraction of '$FILE' completed successfully to '$TARGET_DIR'."
fi
