#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail

# brew-sync: Check and sync Brewfile with installed packages
#
# Usage:
#   brew-sync              # Check for drift and suggest actions
#   brew-sync --add        # Add missing packages to Brewfile
#   brew-sync --remove     # Remove uninstalled packages from Brewfile
#   brew-sync --update     # Update Brewfile from current packages
#   brew-sync --help       # Show help

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/helpers.sh"

BREWFILE="$HOME/dotfiles/Brewfile"
DRY_RUN=false

# Colors (redefine for standalone use)
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_header() {
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  Brewfile Sync${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
}

print_help() {
    echo "Usage: brew-sync [options]"
    echo ""
    echo "Check and synchronize Brewfile with installed Homebrew packages."
    echo ""
    echo "Options:"
    echo "  --add          Add missing packages to Brewfile"
    echo "  --remove       Remove uninstalled packages from Brewfile"
    echo "  --update       Full update: brew bundle dump --force"
    echo "  --check        Only check for drift (default)"
    echo "  --dry-run      Show what would be done without making changes"
    echo "  -h, --help     Show this help message"
    echo ""
    echo "Examples:"
    echo "  brew-sync              # Check for drift"
    echo "  brew-sync --add        # Add missing packages"
    echo "  brew-sync --update     # Regenerate Brewfile from installed"
    exit 0
}

# Parse arguments
ACTION="check"
while [ $# -gt 0 ]; do
    case "$1" in
        --add)
            ACTION="add"
            shift
            ;;
        --remove)
            ACTION="remove"
            shift
            ;;
        --update)
            ACTION="update"
            shift
            ;;
        --check)
            ACTION="check"
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            print_help
            ;;
        *)
            echo "Unknown option: $1"
            echo "Run 'brew-sync --help' for usage."
            exit 1
            ;;
    esac
done

# Check if Brewfile exists
if [ ! -f "$BREWFILE" ]; then
    echo -e "${RED}Error: Brewfile not found at $BREWFILE${NC}"
    exit 1
fi

print_header

# Get lists of packages
get_brewfile_formulae() {
    grep -E '^\s*brew\s+"' "$BREWFILE" 2>/dev/null | \
        sed -E 's/^\s*brew\s+"([^"]+)".*/\1/' | \
        sort -u
}

get_brewfile_casks() {
    grep -E '^\s*cask\s+"' "$BREWFILE" 2>/dev/null | \
        sed -E 's/^\s*cask\s+"([^"]+)".*/\1/' | \
        sort -u
}

get_installed_formulae() {
    brew list --formula 2>/dev/null | sort -u
}

get_installed_casks() {
    brew list --cask 2>/dev/null | sort -u
}

# Compare and report drift
check_drift() {
    echo -e "${BLUE}Checking for drift...${NC}"
    echo ""

    local brewfile_formulae installed_formulae
    local brewfile_casks installed_casks

    brewfile_formulae=$(get_brewfile_formulae)
    installed_formulae=$(get_installed_formulae)
    brewfile_casks=$(get_brewfile_casks)
    installed_casks=$(get_installed_casks)

    # Formulae in Brewfile but not installed
    local formulae_not_installed
    formulae_not_installed=$(comm -23 <(echo "$brewfile_formulae") <(echo "$installed_formulae"))

    # Formulae installed but not in Brewfile
    local formulae_not_in_brewfile
    formulae_not_in_brewfile=$(comm -13 <(echo "$brewfile_formulae") <(echo "$installed_formulae"))

    # Casks in Brewfile but not installed
    local casks_not_installed
    casks_not_installed=$(comm -23 <(echo "$brewfile_casks") <(echo "$installed_casks"))

    # Casks installed but not in Brewfile
    local casks_not_in_brewfile
    casks_not_in_brewfile=$(comm -13 <(echo "$brewfile_casks") <(echo "$installed_casks"))

    # Print results
    local issues_found=false

    if [ -n "$formulae_not_installed" ]; then
        echo -e "${YELLOW}Formulae in Brewfile but not installed:${NC}"
        echo "$formulae_not_installed" | while read -r pkg; do
            echo "  • $pkg"
        done
        echo ""
        issues_found=true
    fi

    if [ -n "$casks_not_installed" ]; then
        echo -e "${YELLOW}Casks in Brewfile but not installed:${NC}"
        echo "$casks_not_installed" | while read -r pkg; do
            echo "  • $pkg"
        done
        echo ""
        issues_found=true
    fi

    if [ -n "$formulae_not_in_brewfile" ]; then
        echo -e "${YELLOW}Formulae installed but not in Brewfile:${NC}"
        echo "$formulae_not_in_brewfile" | while read -r pkg; do
            # Skip autoremovable packages
            if ! brew autoremove --dry-run 2>/dev/null | grep -q "^$pkg$"; then
                echo "  • $pkg"
            fi
        done
        echo ""
        issues_found=true
    fi

    if [ -n "$casks_not_in_brewfile" ]; then
        echo -e "${YELLOW}Casks installed but not in Brewfile:${NC}"
        echo "$casks_not_in_brewfile" | while read -r pkg; do
            echo "  • $pkg"
        done
        echo ""
        issues_found=true
    fi

    # Check for outdated packages
    echo -e "${BLUE}Checking for outdated packages...${NC}"
    local outdated
    outdated=$(brew outdated 2>/dev/null || true)
    if [ -n "$outdated" ]; then
        local outdated_count
        outdated_count=$(echo "$outdated" | wc -l | tr -d ' ')
        echo -e "${YELLOW}$outdated_count outdated package(s) found${NC}"
        echo "$outdated" | head -10 | while read -r pkg; do
            echo "  • $pkg"
        done
        if [ "$outdated_count" -gt 10 ]; then
            echo "  ... and $((outdated_count - 10)) more"
        fi
        echo ""
        issues_found=true
    else
        echo -e "${GREEN}✓ All packages are up to date${NC}"
        echo ""
    fi

    if [ "$issues_found" = false ]; then
        echo -e "${GREEN}✓ Brewfile is in sync with installed packages${NC}"
        return 0
    else
        echo -e "${BLUE}Run 'brew-sync --add' to add missing packages${NC}"
        echo -e "${BLUE}Run 'brew-sync --remove' to clean up Brewfile${NC}"
        echo -e "${BLUE}Run 'brew-sync --update' to regenerate from installed${NC}"
        return 1
    fi
}

# Add missing packages to Brewfile
add_missing() {
    if [ "$DRY_RUN" = true ]; then
        echo -e "${BLUE}[DRY RUN] Would add missing packages to Brewfile${NC}"
    else
        echo -e "${BLUE}Adding missing packages to Brewfile...${NC}"
    fi

    local brewfile_formulae installed_formulae
    local brewfile_casks installed_casks

    brewfile_formulae=$(get_brewfile_formulae)
    installed_formulae=$(get_installed_formulae)
    brewfile_casks=$(get_brewfile_casks)
    installed_casks=$(get_installed_casks)

    # Find missing formulae
    local formulae_to_add
    formulae_to_add=$(comm -13 <(echo "$brewfile_formulae") <(echo "$installed_formulae"))

    # Find missing casks
    local casks_to_add
    casks_to_add=$(comm -13 <(echo "$brewfile_casks") <(echo "$installed_casks"))

    if [ -z "$formulae_to_add" ] && [ -z "$casks_to_add" ]; then
        echo -e "${GREEN}✓ Nothing to add${NC}"
        return 0
    fi

    # Add formulae
    if [ -n "$formulae_to_add" ]; then
        echo -e "${BLUE}Adding formulae:${NC}"
        echo "$formulae_to_add" | while read -r pkg; do
            echo "  + $pkg"
            if [ "$DRY_RUN" = false ]; then
                # Try to detect if it has a tap
                local tap_info
                tap_info=$(brew info "$pkg" 2>/dev/null | head -1 || true)
                if echo "$tap_info" | grep -q "/"; then
                    # Has a tap prefix
                    echo "brew \"$pkg\"" >> "$BREWFILE"
                else
                    echo "brew \"$pkg\"" >> "$BREWFILE"
                fi
            fi
        done
    fi

    # Add casks
    if [ -n "$casks_to_add" ]; then
        echo ""
        echo -e "${BLUE}Adding casks:${NC}"
        echo "$casks_to_add" | while read -r pkg; do
            echo "  + $pkg"
            if [ "$DRY_RUN" = false ]; then
                echo "cask \"$pkg\"" >> "$BREWFILE"
            fi
        done
    fi

    if [ "$DRY_RUN" = false ]; then
        echo ""
        echo -e "${GREEN}✓ Packages added to Brewfile${NC}"
        echo -e "${YELLOW}Note: You may want to organize the Brewfile manually${NC}"
    fi
}

# Remove uninstalled packages from Brewfile
remove_uninstalled() {
    if [ "$DRY_RUN" = true ]; then
        echo -e "${BLUE}[DRY RUN] Would remove uninstalled packages from Brewfile${NC}"
    else
        echo -e "${BLUE}Removing uninstalled packages from Brewfile...${NC}"
    fi

    local brewfile_formulae installed_formulae
    local brewfile_casks installed_casks

    brewfile_formulae=$(get_brewfile_formulae)
    installed_formulae=$(get_installed_formulae)
    brewfile_casks=$(get_brewfile_casks)
    installed_casks=$(get_installed_casks)

    # Find formulae to remove
    local formulae_to_remove
    formulae_to_remove=$(comm -23 <(echo "$brewfile_formulae") <(echo "$installed_formulae"))

    # Find casks to remove
    local casks_to_remove
    casks_to_remove=$(comm -23 <(echo "$brewfile_casks") <(echo "$installed_casks"))

    if [ -z "$formulae_to_remove" ] && [ -z "$casks_to_remove" ]; then
        echo -e "${GREEN}✓ Nothing to remove${NC}"
        return 0
    fi

    # Show what will be removed
    if [ -n "$formulae_to_remove" ]; then
        echo -e "${YELLOW}Formulae to remove:${NC}"
        echo "$formulae_to_remove" | while read -r pkg; do
            echo "  - $pkg"
        done
    fi

    if [ -n "$casks_to_remove" ]; then
        echo ""
        echo -e "${YELLOW}Casks to remove:${NC}"
        echo "$casks_to_remove" | while read -r pkg; do
            echo "  - $pkg"
        done
    fi

    if [ "$DRY_RUN" = false ]; then
        # Create backup
        cp "$BREWFILE" "$BREWFILE.backup.$(date +%Y%m%d-%H%M%S)"

        # Remove lines from Brewfile
        local temp_file
        temp_file=$(mktemp)

        while IFS= read -r line; do
            local should_keep=true

            # Check if line is a brew line with a package to remove
            if echo "$line" | grep -qE '^\s*brew\s+"'; then
                local pkg
                pkg=$(echo "$line" | sed -E 's/^\s*brew\s+"([^"]+)".*/\1/')
                if echo "$formulae_to_remove" | grep -q "^${pkg}$"; then
                    should_keep=false
                fi
            fi

            # Check if line is a cask line with a package to remove
            if echo "$line" | grep -qE '^\s*cask\s+"'; then
                local pkg
                pkg=$(echo "$line" | sed -E 's/^\s*cask\s+"([^"]+)".*/\1/')
                if echo "$casks_to_remove" | grep -q "^${pkg}$"; then
                    should_keep=false
                fi
            fi

            if [ "$should_keep" = true ]; then
                echo "$line" >> "$temp_file"
            fi
        done < "$BREWFILE"

        mv "$temp_file" "$BREWFILE"

        echo ""
        echo -e "${GREEN}✓ Uninstalled packages removed from Brewfile${NC}"
        echo -e "${BLUE}Backup saved to:${NC} $BREWFILE.backup.*"
    fi
}

# Full update - regenerate Brewfile
update_brewfile() {
    if [ "$DRY_RUN" = true ]; then
        echo -e "${BLUE}[DRY RUN] Would regenerate Brewfile from installed packages${NC}"
    else
        echo -e "${BLUE}Regenerating Brewfile...${NC}"
        echo -e "${YELLOW}This will overwrite your current Brewfile!${NC}"
        read -p "Continue? [y/N] " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi

        # Backup existing
        cp "$BREWFILE" "$BREWFILE.backup.$(date +%Y%m%d-%H%M%S)"

        # Regenerate
        brew bundle dump --file="$BREWFILE" --force

        echo ""
        echo -e "${GREEN}✓ Brewfile updated${NC}"
        echo -e "${BLUE}Backup saved to:${NC} $BREWFILE.backup.*"
        echo -e "${YELLOW}Note: You may want to reorganize categories manually${NC}"
    fi
}

# Main
case "$ACTION" in
    check)
        check_drift
        ;;
    add)
        add_missing
        ;;
    remove)
        remove_uninstalled
        ;;
    update)
        update_brewfile
        ;;
    *)
        echo "Unknown action: $ACTION"
        exit 1
        ;;
esac
