#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail

# cheatsheet: Quick reference for your dotfiles aliases, keybindings, and functions
#
# Parses .zshrc, .tmux.conf, and .gitconfig for aliases/keybindings
# and displays them with fzf for fuzzy searching

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"

print_help() {
    echo "Usage: cheatsheet [filter]"
    echo ""
    echo "Quick reference for your dotfiles aliases and keybindings."
    echo ""
    echo "Arguments:"
    echo "  filter    Optional: git, zsh, tmux, fzf, alias, function, all"
    echo "            If omitted, opens fzf to search everything"
    echo ""
    echo "Options:"
    echo "  -l, --list    List without fzf (plain text)"
    echo "  -h, --help    Show this help message"
    echo ""
    echo "Examples:"
    echo "  cheatsheet           # Interactive fzf search"
    echo "  cheatsheet git       # Show only git-related entries"
    echo "  cheatsheet tmux      # Show only tmux keybindings"
    echo "  cheatsheet -l        # Plain text list (pipe-friendly)"
    exit 0
}

# Colors for plain output
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
DIM='\033[2m'
NC='\033[0m'

parse_zsh_aliases() {
    local zshrc="$DOTFILES_DIR/.zshrc"
    [[ -f "$zshrc" ]] || return

    # Simple aliases: alias foo='bar'
    grep -E "^alias [^-]" "$zshrc" 2>/dev/null | while IFS= read -r line; do
        local name value
        name=$(echo "$line" | sed "s/^alias //" | cut -d'=' -f1)
        value=$(echo "$line" | cut -d'=' -f2- | sed "s/^['\"]//;s/['\"]$//")
        printf "[zsh-alias]  %-16s → %s\n" "$name" "$value"
    done

    # Global aliases: alias -g FOO='bar'
    grep -E "^alias -g " "$zshrc" 2>/dev/null | while IFS= read -r line; do
        local name value
        name=$(echo "$line" | sed "s/^alias -g //" | cut -d'=' -f1)
        value=$(echo "$line" | cut -d'=' -f2- | sed "s/^['\"]//;s/['\"]$//")
        printf "[zsh-global] %-16s → %s\n" "$name" "$value"
    done
}

parse_zsh_functions() {
    local zshrc="$DOTFILES_DIR/.zshrc"
    [[ -f "$zshrc" ]] || return

    # Functions defined as: function name() { or name() {
    grep -E "^(function )?[a-zA-Z_][a-zA-Z0-9_]*\(\)" "$zshrc" 2>/dev/null | while IFS= read -r line; do
        local name
        name=$(echo "$line" | sed 's/^function //' | sed 's/().*//')
        printf "[zsh-func]   %-16s   defined in .zshrc\n" "$name"
    done
}

parse_zsh_fzf() {
    local zshrc="$DOTFILES_DIR/.zshrc"
    [[ -f "$zshrc" ]] || return

    # fzf functions
    grep -E "^\s+(fcd|fkill|fbr|flog|fsearch)\(\)" "$zshrc" 2>/dev/null | while IFS= read -r line; do
        local name
        name=$(echo "$line" | sed 's/().*//' | xargs)
        local desc=""
        case "$name" in
            fcd)     desc="Fuzzy cd into directory" ;;
            fkill)   desc="Fuzzy kill process" ;;
            fbr)     desc="Fuzzy git checkout branch" ;;
            flog)    desc="Fuzzy git log browser" ;;
            fsearch) desc="Fuzzy search file contents + open in editor" ;;
        esac
        printf "[fzf]        %-16s   %s\n" "$name" "$desc"
    done
}

parse_git_aliases() {
    local gitconfig="$DOTFILES_DIR/.gitconfig"
    [[ -f "$gitconfig" ]] || return

    # Use git config to list aliases (outputs alias.name value, multiline values on separate lines)
    git config -f "$gitconfig" --get-regexp '^alias\.' 2>/dev/null | \
        grep '^alias\.' | \
        while IFS= read -r line; do
            local name value
            name=$(echo "$line" | sed 's/^alias\.//' | cut -d' ' -f1)
            value=$(echo "$line" | sed 's/^alias\.[^ ]* //')

            if echo "$value" | grep -q '!a() {'; then
                printf "[git-commit] git %-12s   conventional commit: %s(...)\n" "$name" "$name"
            else
                if [[ ${#value} -gt 80 ]]; then
                    value="${value:0:77}..."
                fi
                printf "[git-alias]  git %-12s → git %s\n" "$name" "$value"
            fi
        done
}

parse_tmux_bindings() {
    local tmuxconf="$DOTFILES_DIR/.tmux.conf"
    [[ -f "$tmuxconf" ]] || return

    # Strip comments, then process bind lines
    sed 's/#.*$//' "$tmuxconf" | grep -E "^(bind|bind-key) " 2>/dev/null | \
        grep -v "copy-mode" | \
        while IFS= read -r line; do
            local key action prefix="prefix +"
            # Normalize: strip "bind-key" or "bind" prefix
            local rest
            rest=$(echo "$line" | sed 's/^bind-key //' | sed 's/^bind //')

            # Handle flags
            if [[ "$rest" == -n\ * ]]; then
                prefix=""
                rest="${rest#-n }"
                # Strip quotes around the key
                rest=$(echo "$rest" | sed "s/^'//;s/' / /")
            elif [[ "$rest" == -r\ * ]]; then
                prefix="prefix + "
                rest="${rest#-r }"
            fi

            key=$(echo "$rest" | awk '{print $1}')
            action=$(echo "$rest" | sed 's/^[^ ]* //' | sed 's/^[[:space:]]*//')

            # Truncate long actions
            if [[ ${#action} -gt 60 ]]; then
                action="${action:0:57}..."
            fi

            if [[ -n "$prefix" ]]; then
                printf "[tmux]       %-16s   %s\n" "${prefix}${key}" "$action"
            else
                printf "[tmux]       %-16s   %s (no prefix)\n" "$key" "$action"
            fi
        done
}

collect_all() {
    local filter="${1:-all}"

    case "$filter" in
        git)
            parse_git_aliases
            ;;
        zsh|alias)
            parse_zsh_aliases
            parse_zsh_functions
            parse_zsh_fzf
            ;;
        tmux)
            parse_tmux_bindings
            ;;
        fzf)
            parse_zsh_fzf
            ;;
        function|func)
            parse_zsh_functions
            parse_zsh_fzf
            ;;
        all|*)
            parse_zsh_aliases
            parse_zsh_functions
            parse_zsh_fzf
            parse_git_aliases
            parse_tmux_bindings
            ;;
    esac
}

# Main
LIST_MODE=false
FILTER="all"

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            print_help
            ;;
        -l|--list)
            LIST_MODE=true
            shift
            ;;
        *)
            FILTER="$1"
            shift
            ;;
    esac
done

if [[ "$LIST_MODE" == true ]]; then
    collect_all "$FILTER"
elif command -v fzf &>/dev/null; then
    collect_all "$FILTER" | fzf --ansi --no-sort --header="Cheatsheet ($FILTER) — type to filter"
else
    collect_all "$FILTER"
fi
